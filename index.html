<!DOCTYPE html>
<meta charset="utf-8">
<title>Web Mapping Open Data - GeoRodeo 2016</title>
<link rel="stylesheet" href="./css/leaflet.css" media="screen" type="text/css" />
<link rel="stylesheet" href="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/themes/css/cartodb.css" />
<style>

    body {
        padding: 0;
        margin: 0;
    }
    
    #map {
        width: 100%;
        height: 200px;
        /* height overridden with setSize() */
    }

</style>

<div id="map"></div>

<script src="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js"></script>
<script src="./js/leaflet.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/leaflet.esri/2.0.0-beta.8/esri-leaflet.js" type="text/javascript"></script>
<script src="./js/turf.count.min.js" type="text/javascript"></script>
<script src="./data/atx_council_districts_reduced.js" type="text/javascript"></script>
  
<script>
            
    function main(){
        
        // make a map
        map = new L.Map("map", {center: [30.28, -97.735], zoom: 12, minZoom: 1, maxZoom: 20});
        
        // load basemap
        var Stamen_TonerLite = L.tileLayer('http://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.{ext}', {
            attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            subdomains: 'abcd',
            minZoom: 0,
            maxZoom: 20,
            ext: 'png'
        }).addTo(map);
        
        // style objects
        var districtStyle = {
            "color" : "white",
            "fillColor" : "black",
            "weight" : 2
        };

        var precinctStyle = {
            "color" : "black",
            "fillColor" : "orange",
            "weight" : 1
        };        
               
        // add Esri feature layer
       travis_county = L.esri.featureLayer({
            url: 'http://services.arcgis.com/0L95CJ0VTaxqcmED/ArcGIS/rest/services/Travis_County/FeatureServer/0',
            style: districtStyle
        }).addTo(map);
                
                
        //  add CartoDB geojson
        var precincts = L.geoJson();    
        var sql = new cartodb.SQL({ user: 'spatialaustin', format: 'geojson' });
        sql.execute("SELECT * FROM atx_prop_1_results_7_may_2016").done(function(geojson) {
            precincts.addData(geojson)       
        
        // .addTo(map);
        
        precincts.setStyle(precinctStyle);
        
        });
        
        // add local geojson layer
        var council_districts = new L.geoJson(districts, {"style":districtStyle}).addTo(map);
        
        // add 311 data from City of Austin Open Data Portal (using jquery AJAX)
        var lost_in_drain = new L.geoJson();
        
        var council_districts_counted = new L.geoJson(false, {onEachFeature: onEachFeature}).addTo(map);
        
        $.getJSON("https://data.austintexas.gov/resource/5h38-fd8d.geojson?sr_type_code=ZZANIMAL&$select=sr_created_date,sr_location_lat_long",function(geojson){
            lost_in_drain.addData(geojson);
              var counted = turf.count(districts, geojson, 'service_request_count');  // count 311 srs in each council district polygon and add to map
              council_districts_counted.addData(counted);
        })

        // base layers 
        var baseLayers = {
            "Stamen Toner (Lite)" : Stamen_TonerLite
        };

        var overlays = {
            "Council Districts" : council_districts,
            "Precincts" : precincts,
            "Item Lost in Storm Drain" : lost_in_drain
        };
        
        // Layer Control
        layerControl = L.control.layers(baseLayers, overlays).addTo(map);        
        
        function onEachFeature(feature, layer) {
            var councilDistrict = feature.properties.council_di;
            var totalServiceRequests =  feature.properties.service_request_count;
            var popUpContent = "District " + councilDistrict + ": " + feature.properties.service_request_count + " items lost in drain"
            layer.bindPopup(popUpContent);
        }
    }
    
    // map window sizing 
    window.addEventListener('resize', function(){
            var h = window.innerHeight; 
            document.getElementById('map').style.height = h + "px"
    }, true);
        
    window.onload = function() {
        setSize();
        main();
    };
    
    function setSize(){
        var w = window.innerWidth;
        var h = window.innerHeight;
        document.getElementById('map').style.height = h + "px";
    }
    
</script>

